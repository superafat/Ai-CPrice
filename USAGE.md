# 使用指引

## 🚀 快速開始

### 1. 系統啟動
```bash
# 複製並編輯環境配置
cp .env.example .env

# 設定 Mathpix API 金鑰（可選，用於兜底）
# 編輯 .env 檔案中的 MATHPIX_APP_ID 和 MATHPIX_APP_KEY

# 啟動系統
./start.sh
```

### 2. 訪問系統
- **前端界面**: http://localhost:3000
- **管理後台**: http://localhost:3000/management
- **API 文檔**: http://localhost:8000/docs

## 📱 使用流程

### 步驟 1: 上傳題目
1. 點擊「開始上傳」或訪問上傳頁面
2. 拖拽圖片檔案到上傳區域，或點擊選擇檔案
3. 支援格式：JPG, PNG, WebP, PDF
4. 檔案大小限制：50MB

**拍攝建議**:
- 使用充足光線，避免陰影
- 保持手機與紙面平行
- 確保題目完整在畫面內
- 單一題目效果最佳

### 步驟 2: 自動處理
系統將自動執行以下步驟：
1. **影像前處理**: 去噪、增強對比、矯正傾斜
2. **單題切塊**: 識別題號、分割區域
3. **區塊分類**: 判斷題幹、選項、公式類型
4. **OCR 識別**: 雙引擎並行處理
5. **標準化**: 轉換為 Markdown+LaTeX 格式

**處理時間**: 通常 3-6 秒完成

### 步驟 3: 預覽校對
1. 檢視識別結果
2. 注意橘色標示的低信心區塊
3. 點擊編輯按鈕手動修正錯誤
4. 公式將以 KaTeX 渲染顯示

**校對重點**:
- 檢查數學公式是否正確
- 確認選項標號 (A)(B)(C)(D)
- 驗證文字內容完整性

### 步驟 4: 匯出設定
1. 調整字體大小：
   - 題幹/選項：8-16pt（預設 11pt）
   - 詳解：8-16pt（預設 9pt）
2. 圖片設定：
   - 是否包含圖說
   - 最大寬度（預設 14cm）
3. 即時預覽效果

### 步驟 5: 下載 Word 文檔
1. 點擊「匯出 Word 文檔」
2. 系統生成包含 OMML 公式的 .docx 檔案
3. 點擊「下載文檔」取得檔案

**Word 文檔特色**:
- 所有公式為 Word 原生格式（可編輯）
- 圖片原位插入，不會飄移
- 自訂段落樣式與字體大小

## 🔧 進階功能

### 多題處理
- 系統會自動檢測多題情況
- 建議使用裁切工具分割為單題
- 支援批次匯出多個題目

### 重試機制
- 識別失敗時可手動重試
- 提供「高畫質重試」選項
- 系統自動升級處理策略

### 管理監控
- 查看系統統計與效能指標
- 監控 OCR 引擎使用狀況
- 管理 Mathpix 配額使用

## 📋 測試驗證

### 執行測試
```bash
# 完整測試
cd tests && ./run_tests.sh

# 僅 API 測試
cd tests && python3 test_runner.py

# 生成樣本
cd tests && python3 generate_samples.py
```

### 驗證標準
- 單題成功率 ≥ 95%
- 平均處理時間 ≤ 6 秒
- 兜底觸發率 ≤ 5%
- LaTeX 可編譯率 ≥ 98%

## 🛠️ 故障排除

### 常見問題

#### 1. 上傳失敗
**症狀**: 檔案無法上傳或上傳後無回應
**解決**:
- 檢查檔案格式是否支援
- 確認檔案大小 < 50MB
- 檢查網路連線

#### 2. OCR 識別錯誤
**症狀**: 文字或公式識別不準確
**解決**:
- 使用「高畫質重試」
- 檢查圖片清晰度
- 手動校對修正

#### 3. Word 匯出失敗
**症狀**: 無法生成 Word 文檔
**解決**:
- 檢查 Pandoc 是否安裝
- 驗證 LaTeX 語法正確性
- 查看後端日誌錯誤訊息

#### 4. 公式無法編輯
**症狀**: Word 中的公式無法編輯
**解決**:
- 確認使用最新版 Word
- 檢查 OMML 轉換是否成功
- 重新匯出文檔

### 系統維護

#### 清理舊檔案
```bash
# 手動清理
make clean

# 或使用 API
curl -X POST http://localhost:8000/api/management/cleanup
```

#### 重置配額
```bash
curl -X POST http://localhost:8000/api/management/quota/reset
```

#### 檢查系統狀態
```bash
make status
```

## 📞 技術支援

### 日誌位置
- **應用日誌**: `logs/app.log`
- **錯誤日誌**: `logs/app_error.log`
- **測試日誌**: `tests/test_execution.log`

### 除錯模式
```bash
# 設定 DEBUG=true 並重啟
echo "DEBUG=true" >> .env
make restart
```

### 聯繫支援
遇到問題時，請提供：
1. 錯誤訊息截圖
2. 相關日誌檔案
3. 使用的圖片檔案（如可分享）
4. 系統環境資訊

## 🎯 最佳實踐

### 拍攝建議
- **光線**: 使用自然光或充足室內光
- **角度**: 手機與紙面保持平行
- **距離**: 30-50cm 拍攝距離
- **內容**: 確保題目完整，避免裁切

### 使用技巧
- **單題拍攝**: 一張圖片一個題目效果最佳
- **公式清晰**: 確保數學符號清楚可見
- **及時校對**: 預覽階段仔細檢查識別結果
- **批次處理**: 多個題目可批次匯出

### 效能優化
- **合理並發**: 避免同時處理過多檔案
- **定期清理**: 清理不需要的舊檔案
- **監控配額**: 注意 Mathpix 使用量
- **品質控制**: 上傳高品質圖片可提升效果